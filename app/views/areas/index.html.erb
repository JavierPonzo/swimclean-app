<div id="map" style="height: 600px;"></div>

<% if current_user&.admin? %>
  <%= form_with model: @area, url: areas_path, local: true do |f| %>
    <div id="admin-form" class="p-3 bg-light border rounded" style="display: none;">
      <%= f.label :name %>
      <%= f.text_field :name %><br>
      <%= f.hidden_field :lat, id: "area_lat" %>
      <%= f.hidden_field :lng, id: "area_lng" %><br>
      <%= f.submit "Add Spot", class: "btn btn-primary" %>
    </div>
  <% end %>
<% end %>

<%= form_with url: reports_path, local: true do |f| %>
  <%= f.select :area_id, options_from_collection_for_select(@areas, :id, :name) %>
  <%= f.select :algae_level, options_for_select(["none", "medium", "high"]) %>
  <%= f.text_area :comment, placeholder: "Optional comment" %>
  <%= f.submit "Submit Report", class: "btn btn-success" %>
<% end %>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  const map = L.map('map').setView([47.6636, 9.1842], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Map data Â© OpenStreetMap contributors'
  }).addTo(map);

  const areas = <%= raw @areas.to_json %>;

  areas.forEach(area => {
    const color = area.algae_index < 0.5 ? 'green' : area.algae_index < 1.3 ? 'yellow' : 'red';
    const marker = L.circleMarker([area.lat, area.lng], {
      radius: 10,
      fillColor: color,
      color: "#000",
      weight: 1,
      fillOpacity: 0.8
    }).addTo(map);

    marker.bindPopup(`
      <b>${area.name}</b><br>
      Algae Index: ${area.algae_index.toFixed(1)}<br>
      <a href='#' class='btn btn-sm btn-primary'>Report</a>
    `);
  });

  map.on('click', function (e) {
    <% if current_user&.admin? %>
      document.getElementById('admin-form').style.display = 'block';
      document.getElementById('area_lat').value = e.latlng.lat;
      document.getElementById('area_lng').value = e.latlng.lng;
    <% end %>
  });
</script>
